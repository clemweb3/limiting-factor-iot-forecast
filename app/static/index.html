<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CozySense | Smart Climate</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #020617;
            --color1: #2563eb; 
            --color2: #7c3aed;
            --color3: #10b981;
            --accent: #10b981;
            --liquid-glass: rgba(255, 255, 255, 0.03);
            --liquid-border: rgba(255, 255, 255, 0.08);
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%;
            min-height: 100dvh; font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); color: white; overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* --- YOUR ORIGINAL MESH BACKGROUND --- */
        .mesh-container {
            position: fixed; inset: 0; z-index: -1;
            background: radial-gradient(circle at 50% 50%, #0f172a 0%, #020617 100%);
            overflow: hidden;
        }

        .mesh-ball {
            position: absolute; border-radius: 50%; filter: blur(80px);
            opacity: 0.35; animation: move 20s infinite alternate ease-in-out;
        }
        .ball-1 { width: 450px; height: 450px; background: var(--color1); top: -10%; left: -5%; }
        .ball-2 { width: 550px; height: 550px; background: var(--color2); bottom: -10%; right: -5%; animation-delay: -5s; }
        .ball-3 { width: 300px; height: 300px; background: var(--color3); top: 40%; left: 25%; animation-delay: -10s; }

        @keyframes move {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(80px, 120px) scale(1.1); }
        }

        /* --- SMART HOME MINIMALIST FRONT UI --- */
        #onboarding-screen {
            height: 100dvh; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            padding: 0 30px;
            transition: 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .brand-title {
            font-size: clamp(3rem, 10vw, 5.5rem); 
            font-weight: 800; 
            letter-spacing: -0.03em;
            margin: 0; 
            line-height: 1.1;
            color: #ffffff;
        }

        .fuzzy-subtitle {
            font-size: 1.1rem; 
            color: rgba(255,255,255,0.7); /* Brighter for readability */
            font-weight: 400; 
            margin: 15px 0 40px 0;
            max-width: 400px;
            line-height: 1.5;
            /* Removed All-Caps for a smarter, software-first feel */
        }

        .btn-launch {
            background: #ffffff;
            color: #020617; 
            border: none;
            padding: 18px 40px; 
            border-radius: 100px; /* Rounded pill is more 'Smart Home' friendly */
            font-weight: 600; 
            font-size: 1rem; 
            cursor: pointer;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .btn-launch:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }

        /* --- DASHBOARD UI (STRICTLY RETAINED DESIGN/LOGIC) --- */
        #dashboard-ui {
            opacity: 0; visibility: hidden; height: 100dvh;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: 0.8s ease;
        }

        .main-card {
            width: 400px; padding: 45px; border-radius: 40px;
            position: relative;
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            backdrop-filter: blur(40px) saturate(150%);
            -webkit-backdrop-filter: blur(40px) saturate(150%);
            border: 1px solid var(--liquid-border);
        }

        .temp-val { 
            font-size: 100px; font-weight: 400; letter-spacing: -4px; 
            margin: 10px 0; color: #fff; text-align: center;
        }

        .status-pill {
            display: inline-flex; align-items: center; gap: 10px;
            padding: 10px 22px; border-radius: 100px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--liquid-border);
            color: var(--accent); font-size: 11px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 1px;
        }

        #cta-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 24px; border-radius: 28px;
            margin-top: 25px; border: 1px solid rgba(255,255,255,0.05);
        }

        .pred-item {
            background: rgba(255, 255, 255, 0.02);
            padding: 18px; border-radius: 24px; 
            border: 1px solid rgba(255,255,255,0.05);
            text-align: center;
        }

        #stop-btn {
            width: 100%; margin-top: 30px; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); 
            color: #fff; padding: 18px; border-radius: 20px; 
            font-size: 11px; font-weight: 700; cursor: pointer; 
            text-transform: uppercase; letter-spacing: 1px;
        }

        @media (max-width: 480px) {
            .main-card { width: 88%; padding: 35px 25px; }
            .brand-title { font-size: 3.5rem; }
        }

        .blink-yellow { animation: pulse-yellow 0.8s infinite alternate ease-in-out; }
        @keyframes pulse-yellow {
            0% { border-color: rgba(251, 191, 36, 0.2); }
            100% { border-color: rgba(251, 191, 36, 1); }
        }
    </style>
</head>
<body>

    <div class="mesh-container">
        <div class="mesh-ball ball-1"></div>
        <div class="mesh-ball ball-2"></div>
        <div class="mesh-ball ball-3"></div>
    </div>

    <div id="onboarding-screen">
        <h1 class="brand-title">CozySense</h1>
        <p id="fuzzy-subtitle" class="fuzzy-subtitle"></p>
        <button class="btn-launch" onclick="launchApp()">Begin Session</button>
    </div>

    <div id="dashboard-ui">
        <div class="main-card" id="main-card">
            <button onclick="goHome()" style="position:absolute; top:30px; right:30px; background:none; border:none; color:white; opacity:0.3; font-size:22px; cursor:pointer;">✕</button>
            <div style="text-align: center;">
                <div class="status-pill">
                    <span id="pill-dot" style="width:8px; height:8px; background:var(--accent); border-radius:50%; box-shadow: 0 0 12px var(--accent);"></span>
                    <span id="pill">System Active</span>
                </div>
            </div>
            <div style="margin: 40px 0;">
                <h2 id="state-title" style="font-weight: 400; font-size: 1rem; opacity: 0.5; margin: 0; text-align: center;">Environment Status</h2>
                <div class="temp-val" id="disp-temp">--°</div>
            </div>
            <div id="cta-box">
                <p id="disp-cta" style="margin: 0; font-size: 14px; opacity: 0.8; line-height: 1.6; text-align: center;">Syncing sensors...</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;">
                <div class="pred-item">
                    <small style="opacity:0.4; font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:1px;">30m Outlook</small><br>
                    <b id="d30" style="font-size:22px; color: #fff;">--</b>
                </div>
                <div class="pred-item">
                    <small style="opacity:0.4; font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:1px;">60m Outlook</small><br>
                    <b id="d60" style="font-size:22px; color: #fff;">--</b>
                </div>
            </div>
            <button id="stop-btn" onclick="toggleSensing()">Pause Telemetry</button>
        </div>
    </div>

    <audio id="snd-ping" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>
    <audio id="snd-process" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" loop></audio>
    <audio id="snd-alert" src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3" loop></audio>

    <script>
        /* ALL SENSOR & ALARM LOGIC (UNCHANGED) */
        let previousDecision = "";
        let previousTemp = null;
        let isCalibrating = false;
        let sensingActive = false;
        let engineTimer = null;

        const subtitles = [
            "Your climate, intelligently refined.",
            "Ambient precision in every breath.",
            "The future of sensory comfort.",
            "Stay balanced. Stay aware."
        ];
        document.getElementById('fuzzy-subtitle').innerText = subtitles[Math.floor(Math.random() * subtitles.length)];

        function launchApp() {
            document.getElementById('onboarding-screen').style.opacity = '0';
            document.getElementById('onboarding-screen').style.transform = 'translateY(-20px)';
            setTimeout(() => {
                document.getElementById('onboarding-screen').style.display = 'none';
                document.getElementById('dashboard-ui').style.visibility = 'visible';
                document.getElementById('dashboard-ui').style.opacity = '1';
                startSensing();
            }, 600);
        }

        function goHome() {
            stopSensing();
            document.getElementById('dashboard-ui').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('onboarding-screen').style.display = 'flex';
                document.getElementById('onboarding-screen').style.opacity = '1';
                document.getElementById('onboarding-screen').style.transform = 'translateY(0)';
                document.getElementById('dashboard-ui').style.visibility = 'hidden';
            }, 600);
        }

        function toggleSensing() {
            sensingActive ? stopSensing() : startSensing();
            const btn = document.getElementById('stop-btn');
            btn.innerText = sensingActive ? "Pause Telemetry" : "Resume Telemetry";
        }

        function startSensing() {
            sensingActive = true;
            refresh();
            engineTimer = setInterval(refresh, 3000);
            document.getElementById('snd-ping').play().catch(()=>{});
        }

        function stopSensing() {
            sensingActive = false;
            clearInterval(engineTimer);
            document.getElementById('snd-alert').pause();
            document.getElementById('snd-process').pause();
            document.getElementById('pill').innerText = "Paused";
        }

        async function refresh() {
            if (isCalibrating || !sensingActive) return;
            try {
                const r = await fetch('/history');
                const d = await r.json();
                if(!d || d.length === 0) return;
                const now = d[0];
                const currentT = now.temperature;
                const spikeDetected = (previousTemp !== null && Math.abs(currentT - previousTemp) >= 5.0);
                const stateChanged = (previousDecision !== "" && previousDecision !== now.decision);

                if (spikeDetected || stateChanged) startRecalibration(now, spikeDetected);
                else updateDOM(now);

                previousDecision = now.decision;
                previousTemp = currentT;
            } catch(e) { document.getElementById('pill').innerText = "Offline"; }
        }

        function startRecalibration(targetData, isAnomaly) {
            isCalibrating = true;
            document.getElementById('snd-process').play().catch(()=>{});
            const card = document.getElementById('main-card');
            card.classList.add('blink-yellow');
            document.getElementById('state-title').innerText = isAnomaly ? "Analyzing Anomaly" : "Syncing System...";
            setTimeout(() => {
                document.getElementById('snd-process').pause();
                card.classList.remove('blink-yellow');
                isCalibrating = false;
                updateDOM(targetData);
            }, 3000);
        }

        function updateDOM(data) {
            const [cmd, state] = data.decision.split(':');
            document.getElementById('disp-temp').innerText = Math.round(data.temperature) + "°";
            document.getElementById('state-title').innerText = state.replace(/_/g, ' ');
            document.getElementById('disp-cta').innerText = data.human_notes;
            document.getElementById('d30').innerText = data.prediction_30.toFixed(1) + "°";
            document.getElementById('d60').innerText = data.prediction_60.toFixed(1) + "°";
            document.getElementById('pill').innerText = state;
            
            const isDanger = state.includes("EMERGENCY") || state.includes("COOLING") || data.temperature >= 30;
            const themeColor = isDanger ? "#ef4444" : "#10b981";
            document.documentElement.style.setProperty('--accent', themeColor);
            document.getElementById('pill-dot').style.backgroundColor = themeColor;
            document.getElementById('pill-dot').style.boxShadow = `0 0 12px ${themeColor}`;
            
            if (isDanger && !previousDecision.includes("EMERGENCY")) {
                const alert = document.getElementById('snd-alert');
                alert.play().catch(()=>{});
                setTimeout(() => { alert.pause(); alert.currentTime = 0; }, 5000);
            }
        }
    </script>
</body>
</html>