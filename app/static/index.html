<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CozySense | Advanced Climate Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100;400;900&family=Space+Grotesk:wght@300;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #030712;
            --color1: #1e40af; /* Deep Tech Blue */
            --color2: #4c1d95; /* Luxury Purple */
            --color3: #064e3b; /* Deep Emerald */
            --accent: #10b981;
            /* Advanced Liquid Glass */
            --glass-base: rgba(255, 255, 255, 0.015);
            --glass-border: rgba(255, 255, 255, 0.1);
            --refraction: rgba(255, 255, 255, 0.08);
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Geist', sans-serif; 
            background: var(--bg); color: white; overflow: hidden;
        }

        /* --- MESH BACKGROUND --- */
        .mesh-container {
            position: fixed; inset: 0; z-index: -1;
            background: #020617;
            overflow: hidden;
        }

        .mesh-ball {
            position: absolute; border-radius: 50%; filter: blur(100px);
            opacity: 0.3; animation: drift 25s infinite alternate linear;
        }
        .ball-1 { width: 600px; height: 600px; background: var(--color1); top: -20%; left: -10%; }
        .ball-2 { width: 500px; height: 500px; background: var(--color2); bottom: -10%; right: -5%; }
        
        @keyframes drift {
            from { transform: rotate(0deg) translate(20px); }
            to { transform: rotate(360deg) translate(-20px); }
        }

        /* --- THE LIQUID GLASS LAYER --- */
        .liquid-layer {
            position: absolute; inset: 0;
            backdrop-filter: blur(60px); /* Heavy frost */
            -webkit-backdrop-filter: blur(60px);
            background: radial-gradient(circle at top left, rgba(255,255,255,0.03), transparent);
            pointer-events: none;
            z-index: 1;
        }

        /* --- INITIAL PAGE: INDUSTRIAL BOLD --- */
        #onboarding-screen {
            height: 100dvh; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            position: relative; z-index: 10;
            transition: 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .brand-title {
            font-family: 'Geist', sans-serif;
            font-size: clamp(4rem, 15vw, 9rem); 
            font-weight: 900; 
            letter-spacing: -0.06em;
            margin: 0; line-height: 0.8;
            color: #ffffff;
            /* Technical "Machine-Cut" Look */
            mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
        }

        .sub-tech {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.8rem; font-weight: 300; 
            letter-spacing: 5px; text-transform: uppercase;
            margin: 30px 0 50px 0; opacity: 0.5;
            display: flex; align-items: center; gap: 15px;
        }

        .sub-tech::before, .sub-tech::after {
            content: ""; width: 40px; height: 1px; background: rgba(255,255,255,0.2);
        }

        /* INDUSTRIAL PILL BUTTON */
        .btn-launch {
            background: transparent;
            color: #ffffff; 
            border: 1px solid var(--glass-border);
            padding: 18px 45px; 
            border-radius: 4px; /* Technical square edges */
            font-weight: 600; font-size: 0.75rem; 
            cursor: pointer; text-transform: uppercase; letter-spacing: 3px;
            transition: 0.4s; position: relative;
            overflow: hidden;
        }

        .btn-launch::before {
            content: ""; position: absolute; inset: 0; 
            background: white; opacity: 0; transition: 0.3s;
        }

        .btn-launch:hover {
            color: #000; border-color: white;
        }
        .btn-launch:hover::before { opacity: 1; z-index: -1; }

        /* --- DASHBOARD UI (RETAINED LOGIC) --- */
        #dashboard-ui {
            opacity: 0; visibility: hidden; height: 100dvh;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: 0.8s ease; position: relative; z-index: 10;
        }

        .main-card {
            width: 420px; padding: 50px; border-radius: 20px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--glass-border);
            box-shadow: 0 40px 100px rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
        }

        .temp-val { 
            font-size: 110px; font-weight: 100; letter-spacing: -8px; 
            margin: 10px 0; color: #fff; text-align: center;
            font-family: 'Geist', sans-serif;
        }

        .status-pill {
            display: inline-flex; align-items: center; gap: 10px;
            padding: 8px 18px; border-radius: 4px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
            color: var(--accent); font-size: 10px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 2px;
        }

        #cta-box {
            padding: 20px; border-radius: 4px; margin-top: 25px; 
            border-left: 2px solid var(--accent); background: rgba(255,255,255,0.01);
        }

        .pred-item {
            background: rgba(255, 255, 255, 0.02); padding: 15px; 
            border-radius: 4px; border: 1px solid rgba(255,255,255,0.05);
            text-align: center;
        }

        #stop-btn {
            width: 100%; margin-top: 30px; background: none; 
            border: 1px solid rgba(255,255,255,0.1); 
            color: rgba(255,255,255,0.4); padding: 15px; border-radius: 4px; 
            font-size: 10px; font-weight: 600; cursor: pointer; 
            text-transform: uppercase; letter-spacing: 2px; transition: 0.3s;
        }

        #stop-btn:hover { border-color: white; color: white; }

        .blink-yellow { animation: pulse-yellow 0.8s infinite alternate ease-in-out; }
        @keyframes pulse-yellow {
            0% { border-color: rgba(251, 191, 36, 0.1); }
            100% { border-color: rgba(251, 191, 36, 0.8); }
        }
    </style>
</head>
<body>

    <div class="mesh-container">
        <div class="mesh-ball ball-1"></div>
        <div class="mesh-ball ball-2"></div>
    </div>
    
    <div class="liquid-layer"></div>

    <div id="onboarding-screen">
        <h1 class="brand-title">COZY<br>SENSE</h1>
        <div class="sub-tech" id="fuzzy-subtitle">THERMAL PRECISION</div>
        <button class="btn-launch" onclick="launchApp()">Initialize Telemetry</button>
    </div>

    <div id="dashboard-ui">
        <div class="main-card" id="main-card">
            <button onclick="goHome()" style="position:absolute; top:25px; right:25px; background:none; border:none; color:white; opacity:0.2; cursor:pointer;">CLOSE</button>
            <div style="text-align: center;">
                <div class="status-pill">
                    <span id="pill-dot" style="width:6px; height:6px; background:var(--accent); border-radius:50%;"></span>
                    <span id="pill">Active</span>
                </div>
            </div>
            <div style="margin: 40px 0;">
                <h2 id="state-title" style="font-weight: 300; font-size: 0.8rem; opacity: 0.4; letter-spacing:3px; text-transform:uppercase; text-align: center;">Environment Status</h2>
                <div class="temp-val" id="disp-temp">--째</div>
            </div>
            <div id="cta-box">
                <p id="disp-cta" style="margin: 0; font-size: 13px; opacity: 0.7; line-height: 1.5;">Awaiting sensor calibration...</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;">
                <div class="pred-item">
                    <small style="opacity:0.3; font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:1px;">T + 30m</small><br>
                    <b id="d30" style="font-size:20px; font-weight:400;">--</b>
                </div>
                <div class="pred-item">
                    <small style="opacity:0.3; font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:1px;">T + 60m</small><br>
                    <b id="d60" style="font-size:20px; font-weight:400;">--</b>
                </div>
            </div>
            <button id="stop-btn" onclick="toggleSensing()">Pause Stream</button>
        </div>
    </div>

    <audio id="snd-ping" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>
    <audio id="snd-process" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" loop></audio>
    <audio id="snd-alert" src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3" loop></audio>

    <script>
        /* ALL SENSOR & ALARM LOGIC (UNCHANGED) */
        let previousDecision = "";
        let previousTemp = null;
        let isCalibrating = false;
        let sensingActive = false;
        let engineTimer = null;

        function launchApp() {
            document.getElementById('onboarding-screen').style.opacity = '0';
            document.getElementById('onboarding-screen').style.transform = 'translateY(-10px) scale(1.02)';
            setTimeout(() => {
                document.getElementById('onboarding-screen').style.display = 'none';
                document.getElementById('dashboard-ui').style.visibility = 'visible';
                document.getElementById('dashboard-ui').style.opacity = '1';
                startSensing();
            }, 800);
        }

        function goHome() {
            stopSensing();
            document.getElementById('dashboard-ui').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('onboarding-screen').style.display = 'flex';
                document.getElementById('onboarding-screen').style.opacity = '1';
                document.getElementById('onboarding-screen').style.transform = 'translateY(0) scale(1)';
                document.getElementById('dashboard-ui').style.visibility = 'hidden';
            }, 800);
        }

        function toggleSensing() {
            sensingActive ? stopSensing() : startSensing();
            const btn = document.getElementById('stop-btn');
            btn.innerText = sensingActive ? "Pause Stream" : "Resume Stream";
        }

        function startSensing() {
            sensingActive = true;
            refresh();
            engineTimer = setInterval(refresh, 3000);
            document.getElementById('snd-ping').play().catch(()=>{});
        }

        function stopSensing() {
            sensingActive = false;
            clearInterval(engineTimer);
            document.getElementById('snd-alert').pause();
            document.getElementById('snd-process').pause();
            document.getElementById('pill').innerText = "Paused";
        }

        async function refresh() {
            if (isCalibrating || !sensingActive) return;
            try {
                const r = await fetch('/history');
                const d = await r.json();
                if(!d || d.length === 0) return;
                const now = d[0];
                const currentT = now.temperature;
                const spikeDetected = (previousTemp !== null && Math.abs(currentT - previousTemp) >= 5.0);
                const stateChanged = (previousDecision !== "" && previousDecision !== now.decision);

                if (spikeDetected || stateChanged) startRecalibration(now, spikeDetected);
                else updateDOM(now);

                previousDecision = now.decision;
                previousTemp = currentT;
            } catch(e) { document.getElementById('pill').innerText = "Offline"; }
        }

        function startRecalibration(targetData, isAnomaly) {
            isCalibrating = true;
            document.getElementById('snd-process').play().catch(()=>{});
            const card = document.getElementById('main-card');
            card.classList.add('blink-yellow');
            document.getElementById('state-title').innerText = isAnomaly ? "Analyzing Anomaly" : "Syncing System...";
            setTimeout(() => {
                document.getElementById('snd-process').pause();
                card.classList.remove('blink-yellow');
                isCalibrating = false;
                updateDOM(targetData);
            }, 3000);
        }

        function updateDOM(data) {
            const [cmd, state] = data.decision.split(':');
            document.getElementById('disp-temp').innerText = Math.round(data.temperature) + "째";
            document.getElementById('state-title').innerText = state.replace(/_/g, ' ');
            document.getElementById('disp-cta').innerText = data.human_notes;
            document.getElementById('d30').innerText = data.prediction_30.toFixed(1) + "째";
            document.getElementById('d60').innerText = data.prediction_60.toFixed(1) + "째";
            document.getElementById('pill').innerText = state;
            
            const isDanger = state.includes("EMERGENCY") || state.includes("COOLING") || data.temperature >= 30;
            const themeColor = isDanger ? "#ef4444" : "#10b981";
            document.documentElement.style.setProperty('--accent', themeColor);
            document.getElementById('pill-dot').style.backgroundColor = themeColor;
            
            if (isDanger && !previousDecision.includes("EMERGENCY")) {
                const alert = document.getElementById('snd-alert');
                alert.play().catch(()=>{});
                setTimeout(() => { alert.pause(); alert.currentTime = 0; }, 5000);
            }
        }
    </script>
</body>
</html>