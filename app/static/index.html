<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CozySense | Smart Climate Telemetry</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #020617;
            --color1: #2563eb; 
            --color2: #7c3aed;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #fbbf24;
            --cold: #3b82f6;
            --neutral: rgba(255, 255, 255, 0.4);
            --liquid-border: rgba(255, 255, 255, 0.08);
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%;
            min-height: 100dvh; font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); color: white; overflow: hidden;
        }

        .mesh-container {
            position: fixed; inset: 0; z-index: -1;
            background: radial-gradient(circle at 50% 50%, #0f172a 0%, #020617 100%);
        }
        .mesh-ball {
            position: absolute; border-radius: 50%; filter: blur(80px);
            opacity: 0.3; animation: move 20s infinite alternate ease-in-out;
        }
        .ball-1 { width: 450px; height: 450px; background: var(--color1); top: -10%; left: -5%; }
        .ball-2 { width: 550px; height: 550px; background: var(--color2); bottom: -10%; right: -5%; }

        @keyframes move { 
            0% { transform: translate(0, 0); } 
            100% { transform: translate(100px, 100px); } 
        }

        /* NEW CROSS-BROWSER O-LOADER */
        .loader-ring {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255,255,255,0.1);
            border-top: 6px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #dashboard-ui {
            opacity: 0; visibility: hidden; height: 100dvh;
            display: flex; justify-content: center; align-items: center;
            transition: 0.8s ease;
        }

        .main-card {
            width: 400px; padding: 45px; border-radius: 40px;
            background: linear-gradient(135deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0.01) 100%);
            backdrop-filter: blur(40px); border: 1px solid var(--liquid-border);
            text-align: center; position: relative;
        }

        .temp-val { font-size: 100px; font-weight: 400; letter-spacing: -5px; margin: 0; }
        
        .status-pill {
            display: inline-flex; align-items: center; gap: 10px;
            padding: 10px 22px; border-radius: 100px;
            background: rgba(0,0,0,0.3); border: 1px solid var(--liquid-border);
            font-size: 11px; font-weight: 800; text-transform: uppercase;
        }

        .prediction-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
        .pred-card { background: rgba(255,255,255,0.02); padding: 18px; border-radius: 24px; border: 1px solid transparent; }

        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 30px; }
        
        button {
            width: 100%; border: 1px solid rgba(255,255,255,0.1); padding: 18px;
            border-radius: 20px; font-size: 11px; font-weight: 800; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px; transition: 0.3s;
        }
        
        #stop-btn { background: rgba(255,255,255,0.05); color: #fff; }
        #exit-btn { background: transparent; color: rgba(255,255,255,0.4); border: none; }
        #exit-btn:hover { color: var(--danger); }

        /* THE ANOMALY SCANNER ICON (+ symbol) */
        .anomaly-svg { width: 80px; height: 80px; animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { opacity: 0.4; transform: scale(0.9); } to { opacity: 1; transform: scale(1.1); } }
    </style>
</head>
<body>

    <div class="mesh-container">
        <div class="mesh-ball ball-1"></div>
        <div class="mesh-ball ball-2"></div>
    </div>

    <div id="onboarding-screen" style="height: 100dvh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h1 style="font-size: 4rem; font-weight: 800; margin: 0;">CozySense</h1>
        <p style="opacity: 0.6;">Atmospheric Intelligence Engine</p>
        <button onclick="launchApp()" style="margin-top: 30px; padding: 18px 45px; border-radius: 50px; border: none; cursor: pointer; font-weight: 800; background: white; color: black; width: auto;">Begin Session</button>
    </div>

    <div id="dashboard-ui">
        <div class="main-card" id="main-card">
            <div class="status-pill">
                <span id="pill-dot" style="width:8px; height:8px; border-radius:50%;"></span>
                <span id="pill-text">Initializing...</span>
            </div>

            <div id="display-container" style="margin: 40px 0; position: relative; min-height: 220px; display: flex; align-items: center; justify-content: center;">
                
                <div id="boot-loader" style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                    <div class="loader-ring"></div>
                    <p style="font-size: 10px; opacity: 0.5; letter-spacing: 2px;">SECURE LINK ESTABLISHING</p>
                </div>

                <div id="data-view" style="width: 100%; transition: opacity 0.5s ease; display: none; opacity: 0;">
                    <div class="temp-val" id="disp-temp">--째</div>
                    <p id="disp-cta" style="font-size: 13px; opacity: 0.7; max-width: 280px; margin: 10px auto 0; line-height: 1.5; min-height: 40px;">Waiting for telemetry...</p>
                </div>

                <div id="anomaly-view" style="display: none; position: absolute; z-index: 10;">
                    <svg class="anomaly-svg" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <p style="font-size: 10px; letter-spacing: 2px; text-transform: uppercase; margin-top: 10px; opacity: 0.8; color: var(--accent);">Anomaly Detected</p>
                </div>
            </div>

            <div class="prediction-grid">
                <div class="pred-card">
                    <small style="opacity:0.4; font-size:9px; font-weight:800;">30m Outlook</small><br>
                    <b id="d30" style="font-size:22px;">--</b>
                </div>
                <div class="pred-card">
                    <small style="opacity:0.4; font-size:9px; font-weight:800;">60m Outlook</small><br>
                    <b id="d60" style="font-size:22px;">--</b>
                </div>
            </div>

            <div class="btn-group">
                <button id="stop-btn" onclick="toggleSensing()">Pause Telemetry</button>
                <button id="exit-btn" onclick="exitSession()">Exit Session</button>
            </div>
        </div>
    </div>

    <script>
        let sensingActive = false;
        let refreshInterval = null;
        let isScanning = false;
        let firstLoadComplete = false;
        let activeAnomaly = "";

        function launchApp() {
            document.getElementById('onboarding-screen').style.display = 'none';
            const ui = document.getElementById('dashboard-ui');
            ui.style.visibility = 'visible';
            ui.style.opacity = '1';
            
            // Show loader for exactly 2 seconds before starting data sync
            setTimeout(() => {
                startSensing();
            }, 2000);
        }

        function exitSession() {
            sensingActive = false;
            clearInterval(refreshInterval);
            document.getElementById('dashboard-ui').style.opacity = '0';
            document.getElementById('dashboard-ui').style.visibility = 'hidden';
            setTimeout(() => {
                document.getElementById('onboarding-screen').style.display = 'flex';
                // Reset states for next time
                firstLoadComplete = false;
                document.getElementById('boot-loader').style.display = 'flex';
                document.getElementById('data-view').style.display = 'none';
            }, 800);
        }

        function startSensing() {
            sensingActive = true;
            refresh(); 
            refreshInterval = setInterval(refresh, 3000);
        }

        async function refresh() {
            if (isScanning || !sensingActive) return;

            try {
                const r = await fetch('/history');
                const data = await r.json();
                if(!data || data.length === 0) return;
                
                const latest = data[0];
                const [cmd, state] = latest.decision.split(':');

                document.getElementById('disp-temp').innerText = Math.round(latest.temperature) + "째";
                document.getElementById('disp-cta').innerText = latest.human_notes;
                document.getElementById('d30').innerText = latest.prediction_30.toFixed(1) + "째";
                document.getElementById('d60').innerText = latest.prediction_60.toFixed(1) + "째";

                if (!firstLoadComplete) {
                    document.getElementById('boot-loader').style.display = 'none';
                    const dataView = document.getElementById('data-view');
                    dataView.style.display = 'block';
                    setTimeout(() => { dataView.style.opacity = '1'; }, 50);
                    firstLoadComplete = true;
                }

                if (state.includes("ANOMALY")) {
                    if (activeAnomaly !== state) {
                        runDiagnosticSequence(state, cmd);
                        activeAnomaly = state;
                    } else {
                        applyThemeLogic(cmd, state);
                    }
                } else {
                    activeAnomaly = "";
                    applyThemeLogic(cmd, state);
                }
            } catch(e) { console.error("Sync Error", e); }
        }

        function runDiagnosticSequence(state, cmd) {
            isScanning = true;
            const dataView = document.getElementById('data-view');
            const scanView = document.getElementById('anomaly-view');
            
            dataView.style.opacity = "0";
            setTimeout(() => { if (isScanning) scanView.style.display = "block"; }, 300);
            
            let color = state.includes("COLD") ? "var(--cold)" : "var(--warning)";
            updateTheme(color, "SCANNING...");

            setTimeout(() => {
                scanView.style.display = "none";
                dataView.style.opacity = "1";
                isScanning = false;
                applyThemeLogic(cmd, state);
            }, 2500);
        }

        function applyThemeLogic(cmd, state) {
            let theme = "var(--accent)";
            if (cmd.includes("YELLOW")) theme = "var(--warning)";
            if (cmd.includes("BLUE")) theme = "var(--cold)";
            
            if (state.includes("EMERGENCY")) {
                theme = "var(--danger)";
            }
            updateTheme(theme, state);
        }

        function updateTheme(color, label) {
            document.documentElement.style.setProperty('--accent', color);
            document.getElementById('pill-dot').style.backgroundColor = color;
            document.getElementById('pill-text').innerText = label.replace(/_/g, ' ');
            document.getElementById('pill-text').style.color = color;
        }

        function toggleSensing() {
            if(sensingActive) {
                sensingActive = false;
                clearInterval(refreshInterval);
                updateTheme('var(--neutral)', "Suspended");
                document.getElementById('stop-btn').innerText = "Resume Telemetry";
            } else {
                startSensing();
                document.getElementById('stop-btn').innerText = "Pause Telemetry";
            }
        }
    </script>
</body>
</html>